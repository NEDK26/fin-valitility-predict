import requests
import re
import pandas as pd
import time

# coding=utf-8
import threading
from queue import Queue
import logging
import concurrent.futures
import multiprocessing

import exchange_calendars as xcals
from datetime import datetime
import pytz


def lob_spider(_stock):
    # 获取json数据
    headers = {
        "User-Agent": 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/118.0.0.0 Safari/537.36',
    }
    url = f'https://web.sqt.gtimg.cn/utf8/q={_stock}'
    json = requests.get(url, headers)
    # 处理json数据
    data = re.findall(r'"(.*?)"', json.text)
    data = data[0].split('~')
    # 保存数据
    df = pd.DataFrame(data[2:36], index=None).T

    df.to_csv(f'./OriginLob/{_stock}.csv', mode='a', index=False, header=False)


timezone = pytz.timezone("Etc/GMT+0")


def _get_date():
    date = datetime.now().astimezone(timezone).date()
    return date


class TradeDay:
    exchange = "XSHG"

    def is_trading(self):
        return self._is_trading_day() and self._is_trading_minute()

    def _is_trading_day(self):
        date = _get_date()
        exchange = self._exchange()
        return exchange.is_session(date)

    def _exchange(self):
        return xcals.get_calendar(self.exchange)

    def _is_trading_minute(self):
        exchange = self._exchange()
        return exchange.is_trading_minute(datetime.now().astimezone(timezone).strftime("%Y-%m-%d %H:%M"))


# 定义抓取股票数据的函数
def grab_stock_data(stock):
    try:
        lob_spider(stock)
    except Exception as e:
        print(f"Error grabbing data for {stock}: {e}")


if __name__ == "__main__":
    td = TradeDay()
    # not only the 5 stocks，choose more
    # TODO:
    # stocks = ['sh600519', 'sz002594', 'sz002230', 'sh600036', 'sz300750']
    stocks = ['sh600519', 'sz002594', 'sz002230', 'sh600036', 'sz300750', 'sz002677', 'sh601187', 'sz001278',
              'sz000416', 'sz301276', 'sz000607', 'sz301116', 'sh600729', 'sz301123', 'sz002195', 'sz000651',
              'sz300328', 'sz000796', 'sz300074', 'sh603269', 'sz002052', 'sz300243', 'sh600335', 'sh688330',
              'sz834475', 'sh603519', 'sh688563', 'sh603355', 'sh603839', 'sh603123', 'sz002843', 'sh601228',
              'sz002996', 'sz000727',
              'sh603506', 'sz002144',
              'sz000623',
              'sz300417',
              'sz000967',
              'sh600400',
              'sz300730',
              'sh600452',
              'sz300791',
              'sh688219',
              'sh603608',
              'sz000848',
              'sz002198',
              'sh603896',
              'sz300963',
              'sz003020',
              'sz002401',
              'sz300219',
              'sh688469',
              'sz000800',
              'sz300718',
              'sh603759',
              'sh600850',
              'sh603686',
              'sh601665',
              'sz002287',
              'sz002973',
              'sh600255',
              'sz300902',
              'sz002440',
              'sz300022',
              'sh688228',
              'sz301139',
              'sz835857',
              'sz002921',
              'sh603956',
              'sz002348',
              'sh600229',
              'sh688361',
              'sz301136',
              'sz830839',
              'sh688700',
              'sz300883',
              'sz002529',
              'sz000895',
              'sz300546',
              'sh603989',
              'sz002243',
              'sz873570',
              'sz002706',
              'sh688551',
              'sh688697',
              'sh600331',
              'sz002279',
              'sh601222',
              'sz300508',
              'sz002304',
              'sh603313',
              'sz300363',
              'sz301309',
              'sh688668',
              'sz002766',
              'sz301127',
              'sz002617',
              'sh605208',
              'sh600685',
              'sz002238',
              'sz300591',
              'sz002727',
              'sz301046',
              'sh688234',
              'sz300917',
              'sz300268',
              'sh603198',
              'sz002526',
              'sh603016',
              'sh600182',
              'sz300026',
              'sz002989',
              'sz000816',
              'sz002277',
              'sz000572',
              'sz300943',
              'sz873527',
              'sz003003',
              'sz300112',
              'sz301105',
              'sz300615',
              'sz002506',
              'sz002146',
              'sh688356',
              'sz000530',
              'sz000096',
              'sh603903',
              'sz002212',
              'sz002708',
              'sz300525',
              'sh601186',
              'sz300032',
              'sh688080',
              'sz300833',
              'sz002911',
              'sh600657',
              'sh600156',
              'sh688141',
              'sh600302',
              'sh603980',
              'sz300722',
              'sz002847',
              'sz300069',
              'sz000959',
              'sz301315',
              'sz300008',
              'sh603052',
              'sz300561',
              'sh688176',
              'sz301188',
              'sh600486',
              'sh600909',
              'sz300438',
              'sh688003',
              'sh601568',
              'sh600038',
              'sh688345',
              'sh603833',
              'sh600552',
              'sz002858',
              'sh601702',
              'sh603173',
              'sz300983',
              'sz870976',
              'sz002265',
              'sh600319',
              'sz300059',
              'sz002588',
              'sh601877',
              'sz000430',
              'sh600655',
              'sh688631',
              'sz301156',
              'sh601126',
              'sz833523',
              'sz002274',
              'sz002176',
              'sz002647',
              'sz300531',
              'sh600500',
              'sh603578',
              'sh600200',
              'sh688369',
              'sh600199',
              'sz000631',
              'sh600350',
              'sz002628',
              'sh601377',
              'sh603801',
              'sz002024',
              'sh600509',
              'sh601330',
              'sh688114',
              'sh688031',
              'sh603387',
              'sz002493',
              'sh600456',
              'sh688692',
              'sz301508',
              'sz002341',
              'sz000410',
              'sh603729',
              'sz300389',
              'sh600031',
              'sh603887',
              'sz000558',
              'sh600691',
              'sz000723',
              'sz300584',
              'sh600750',
              'sh688663',
              'sz301141',
              'sz002378',
              'sz002309',
              'sz300144',
              'sz300384',
              'sh603733',
              'sz300087',
              'sz000972',
              'sz000691',
              'sz833429',
              'sz002137',
              'sz300724',
              'sz300341',
              'sz833075',
              'sh603182',
              'sz300135',
              'sz002975',
              'sz300965',
              'sh688589',
              'sz300106',
              'sh688378',
              'sh603689',
              'sz837046',
              'sz000068',
              'sh600029',
              'sz002828',
              'sz002649',
              'sz002200',
              'sh603960',
              'sh605177',
              'sz002159',
              'sz300920',
              'sz002965',
              'sh600979',
              'sz833575',
              'sz000629',
              'sh688049',
              'sz002408',
              'sz002655',
              'sz001387',
              'sh688670',
              'sh603351',
              'sh688220',
              'sh600918',
              'sz000963',
              'sz002822',
              'sh600098',
              'sh600020',
              'sz301085',
              'sh688339',
              'sh600702',
              'sz300738',
              'sz000042',
              'sh601899',
              'sz002390',
              'sz301280',
              'sz001333',
              'sz300306',
              'sz001216',
              'sz300303',
              'sh601799',
              'sz002761',
              'sz002037',
              'sh688296',
              'sz002883',
              'sh688184',
              'sh600390',
              'sz000521',
              'sz301008',
              'sh688055',
              'sh600742',
              'sh603119',
              'sz301066',
              'sz300137',
              'sh603041',
              'sz000779',
              'sz836247',
              'sz002659',
              'sh600714',
              'sh603069',
              'sz002557',
              'sz002937',
              'sz000726',
              'sh600875',
              'sz002096',
              'sz300499',
              'sh603336',
              'sz430556',
              'sz002966',
              'sz301256',
              'sh601669',
              'sh601065',
              'sz300976',
              'sz002245',
              'sh603088',
              'sh600358',
              'sz002786',
              'sz301533',
              'sh605108',
              'sh603322',
              'sh603153',
              'sh600712',
              'sh605318',
              'sz002518',
              'sz300857',
              'sh600467',
              'sz002932',
              'sh603209',
              'sz300440',
              'sh603219',
              'sz301229',
              'sh600215',
              'sz300437',
              'sz000856',
              'sz300093',
              'sz300588',
              'sz300304',
              'sz871981',
              'sh603813',
              'sh600248',
              'sz300534',
              'sz300416',
              'sh600643',
              'sz002668',
              'sh688455',
              'sz002522',
              'sh688786',
              'sz002092',
              'sh600019',
              'sz002353',
              'sz000910',
              'sz002686',
              'sz301033',
              'sh603100',
              'sz300820',
              'sz000428',
              'sz000858',
              'sz873726',
              'sh603177',
              'sh688232',
              'sz300821',
              'sh605507',
              'sz002362',
              'sh688798',
              'sz300167',
              'sz002808',
              'sz300651',
              'sz002209',
              'sh600213',
              'sz300248',
              'sh600050',
              'sh601020',
              'sh601231',
              'sh603800',
              'sz000970',
              'sh603231',
              'sz000971',
              'sz002783',
              'sz300564',
              'sh688205',
              'sh600133',
              'sh603323',
              'sh603567',
              'sz300218',
              'sz002958',
              'sh688332',
              'sh688087',
              'sz301558',
              'sh605337',
              'sh600396',
              'sz301487',
              'sz300858',
              'sz301429',
              'sh688177',
              'sz000636',
              'sz300337',
              'sz301339',
              'sh688119',
              'sh688450',
              'sz002105',
              'sz002667',
              'sh603718',
              'sz301381',
              'sh600969',
              'sz000601',
              'sh600529',
              'sz300184',
              'sh688585',
              'sh603165',
              'sh600808',
              'sz301387',
              'sh600498',
              'sz300970',
              'sz002469',
              'sz839493',
              'sh600563',
              'sh603806',
              'sz003026',
              'sh688187',
              'sz001211',
              'sz001203',
              'sz002962',
              'sh688029',
              'sh603223',
              'sz002791',
              'sz300231',
              'sh600346',
              'sz002611',
              'sh605167',
              'sh603699',
              'sz300539',
              'sz002998',
              'sz873339',
              'sz836699',
              'sz301500',
              'sh603266',
              'sz002047',
              'sz300859',
              'sz002383',
              'sh688216',
              'sz300130',
              'sh601061',
              'sh688066',
              'sh688053',
              'sh688319',
              'sz002512',
              'sh600372',
              'sh688112',
              'sz300160',
              'sz300621',
              'sz300134',
              'sz002757',
              'sh601888',
              'sz002106',
              'sz300197',
              'sz300172',
              'sz001222',
              'sz002216',
              'sh600123',
              'sz300918',
              'sh600208',
              'sz002032',
              'sz300611',
              'sz002478',
              'sz002947',
              'sz300510',
              'sz002130',
              'sz300899',
              'sh688047',
              'sz300161',
              'sh601226',
              'sz300460',
              'sz300043',
              'sz301327',
              'sh603317',
              'sz300494',
              'sh603040',
              'sz300391',
              'sz000877',
              'sz001380',
              'sh600272',
              'sh600322',
              'sh600278',
              'sz002928',
              'sh600715',
              'sh600067',
              'sh688409',
              'sz000089',
              'sz301216',
              'sz002357',
              'sz002128',
              'sz002797',
              'sz872931',
              'sh603507',
              'sz300412',
              'sh601956',
              'sh603058',
              'sz002280',
              'sz300747',
              'sz001226',
              'sz301036',
              'sh600171',
              'sh603605',
              'sz002179',
              'sz835237',
              'sz835508',
              'sh600800',
              'sz834407',
              'sz838810',
              'sz300326',
              'sh600676',
              'sz002131',
              'sh600834',
              'sh605365',
              'sz300335',
              'sh603297',
              'sz001389',
              'sh603035',
              'sz301321',
              'sh603766',
              'sh600678',
              'sz300636',
              'sz002631',
              'sz300720',
              'sz831627',
              'sz300652',
              'sh603633',
              'sh601021',
              'sz002468',
              'sh600936',
              'sz002202',
              'sh600732',
              'sz003028',
              'sz430564',
              'sz301149',
              'sz835640',
              'sz831195',
              'sz300053',
              'sh600219',
              'sz002427',
              'sz300731',
              'sh600816',
              'sz002452',
              'sh603065',
              'sz002821',
              'sz002662',
              'sz301049',
              'sh603158',
              'sh600056',
              'sh600403',
              'sh688076',
              'sh601666',
              'sh603687',
              'sh688617',
              'sh688213',
              'sz002910',
              'sz000070',
              'sh688068',
              'sz301550',
              'sz002749',
              'sh600601',
              'sz000411',
              'sh603075',
              'sz300005',
              'sh603893',
              'sz002133',
              'sz000710',
              'sh688717',
              'sh601985',
              'sh688508',
              'sh601166',
              'sz002282',
              'sz002237',
              'sh600593',
              'sz000612',
              'sh603106',
              'sz002859',
              'sh603010',
              'sh603117',
              'sz002083',
              'sz002880',
              'sz002405',
              'sh601577',
              'sz002003',
              'sz002204',
              'sh601000',
              'sh600841',
              'sh688333',
              'sz002075',
              'sh600022',
              'sh600688',
              'sz002805',
              'sz831726',
              'sh688103',
              'sz300575',
              'sh603997',
              'sh605020',
              'sh600595',
              'sz301103',
              'sz300604',
              'sz000700',
              'sh688001',
              'sz300034',
              'sz300713',
              'sh688237',
              'sh605151',
              'sz300004',
              'sh688210',
              'sh603650',
              'sh688238',
              'sz000021',
              'sz300394',
              'sz836414',
              'sz301170',
              'sz300107',
              'sz002997',
              'sz002661',
              'sh688389',
              'sh600503',
              'sh688336',
              'sz002812',
              'sz301380',
              'sz002471',
              'sz300067',
              'sz000695',
              'sz000023',
              'sz838402',
              'sz301122',
              'sz300864',
              'sh688766',
              'sz300901',
              'sz000528',
              'sh688536',
              'sh603070',
              'sh603889',
              'sh600577',
              'sh603306',
              'sz300180',
              'sh688131',
              'sz300697',
              'sz002756',
              'sh601969',
              'sz002970',
              'sz833284',
              'sh600228',
              'sh688475',
              'sh688307',
              'sh603816',
              'sh600711',
              'sh600562',
              'sh600326',
              'sz002896',
              'sh601866',
              'sz300866',
              'sz301110',
              'sh688353',
              'sz300013',
              'sh603363',
              'sh688118',
              'sz002912',
              'sh688367',
              'sz002331',
              'sz002877',
              'sh688280',
              'sh603239',
              'sz301226',
              'sz300911',
              'sz300489',
              'sz002610',
              'sz000669',
              'sz002591',
              'sh600055',
              'sz300481',
              'sz000811',
              'sz002601',
              'sh601155',
              'sh605198',
              'sz002295',
              'sh603375',
              'sz301285',
              'sz002315',
              'sz300174',
              'sh603499',
              'sz000546',
              'sz300111',
              'sz000592',
              'sz002769',
              'sz002951',
              'sh603162',
              'sz301361',
              'sh601966',
              'sz300505',
              'sz300573',
              'sz002338',
              'sz300142',
              'sz300825',
              'sh600333',
              'sz300143',
              'sh603220',
              'sz870656',
              'sz300685',
              'sh605066',
              'sh600822',
              'sz300213',
              'sz000158',
              'sz300314',
              'sz300203',
              'sh600740',
              'sz002942',
              'sz002218',
              'sh600257',
              'sz300016',
              'sz002672',
              'sh601100',
              'sh600363',
              'sz003008',
              'sz000550',
              'sz300935',
              'sh600516',
              'sh688435',
              'sz002153',
              'sh688190',
              'sz300839',
              'sh600071',
              'sz000400',
              'sz002439',
              'sz301305',
              'sz300469',
              'sh600305',
              'sz300809',
              'sh688549',
              'sh603272',
              'sz301013',
              'sh600764',
              'sz002099',
              'sh603159',
              'sz832171',
              'sh603311',
              'sh601991',
              'sz300332',
              'sz003000',
              'sh603270',
              'sh601890',
              'sz301023',
              'sz000889',
              'sz002107',
              'sz000622',
              'sh605566',
              'sh603218',
              'sz300927',
              'sh688690',
              'sh688621',
              'sh600007',
              'sz002217',
              'sz301358',
              'sz300868',
              'sh603708',
              'sz301186',
              'sz300474',
              'sz000906',
              'sz002593',
              'sh601611',
              'sh600539',
              'sz002956',
              'sh603107',
              'sh605060',
              'sz002746',
              'sz002251',
              'sz300513',
              'sh600858',
              'sz301348',
              'sh600355',
              'sz002330',
              'sh688179',
              'sh603338',
              'sh600288',
              'sh603668',
              'sh603982',
              'sz002596',
              'sz301503',
              'sh600718',
              'sz002328',
              'sz836504',
              'sz301367',
              'sh600505',
              'sz000571',
              'sh688252',
              'sz300739',
              'sh600339',
              'sz001287',
              'sz002188',
              'sh601601',
              'sh603655',
              'sz003023',
              'sz301080',
              'sh603101',
              'sh600491',
              'sh601618',
              'sz002352',
              'sh603282',
              'sz839371',
              'sz002726',
              'sh600120',
              'sz002476',
              'sz000908',
              'sh688225',
              'sz300088',
              'sz300281',
              'sz300677',
              'sz000777',
              'sz002185',
              'sh601636',
              'sz002848',
              'sz300100',
              'sz300800',
              'sh603268',
              'sz002969',
              'sh688061',
              'sz300445',
              'sz000600',
              'sz300639',
              'sz000029',
              'sz300921',
              'sz300960',
              'sz300581',
              'sz300628',
              'sz300910',
              'sz002334',
              'sz000563',
              'sh603959',
              'sz002576',
              'sz000026',
              'sz872541',
              'sh600282',
              'sh600681',
              'sz002530',
              'sz003001',
              'sh601619',
              'sh603667',
              'sh603118',
              'sh688272',
              'sz000793',
              'sh688007',
              'sz301329',
              'sz002933',
              'sz000790',
              'sh600112',
              'sz836957',
              'sz873305',
              'sh600630',
              'sz000524',
              'sh600638',
              'sz300369',
              'sh603121',
              'sz300317',
              'sz002377',
              'sz000166',
              'sh600428',
              'sz835179',
              'sz300021',
              'sz300164',
              'sz002301',
              'sh600968',
              'sz301000',
              'sz300192',
              'sz002039',
              'sz000503',
              'sz002508',
              'sz300942',
              'sz000925',
              'sz300672',
              'sz001201',
              'sh688500',
              'sz300102',
              'sz002823',
              'sh603527',
              'sz002333',
              'sh600620',
              'sz301161',
              'sh603768',
              'sh603869',
              'sz301076',
              'sz002424',
              'sh603879',
              'sz836395',
              'sh600933',
              'sz430489',
              'sh603863',
              'sh600030',
              'sh600382',
              'sz301210',
              'sz300913',
              'sh688148',
              'sz001219',
              'sh688153',
              'sz301052',
              'sh603003',
              'sh603180',
              'sh600612',
              'sz002327',
              'sh688772',
              'sz831167',
              'sz833580',
              'sh603319',
              'sh600371',
              'sh603906',
              'sz002283',
              'sz000061',
              'sh603697',
              'sz300803',
              'sz002714',
              'sh601033',
              'sz835305',
              'sz301091',
              'sz001366',
              'sz000728',
              'sz300578',
              'sh603993',
              'sh600661',
              'sz300950',
              'sh601988',
              'sz301512',
              'sh600084',
              'sh603030',
              'sz002156',
              'sh603477',
              'sz002719',
              'sh600815',
              'sz301208',
              'sh600126',
              'sz000807',
              'sz300247',
              'sz300258',
              'sh688239',
              'sh688400',
              'sh603628',
              'sh601137',
              'sz001213',
              'sz000677',
              'sz000009',
              'sh605296',
              'sz300298',
              'sh603803',
              'sz000655',
              'sz300275',
              'sz002207',
              'sz300121',
              'sz002782',
              'sz002978',
              'sh600470',
              'sz301180',
              'sz002446',
              'sh600537',
              'sh600809',
              'sz300810',
              'sz002186',
              'sh600356',
              'sz002768',
              'sz832175',
              'sz837403',
              'sh688275',
              'sz003009',
              'sz300242',
              'sz300770',
              'sh601360',
              'sz300471',
              'sh688698',
              'sz839792',
              'sz002561',
              'sh603611',
              'sz300441',
              'sz002568',
              'sz837663',
              'sh600490',
              'sh600908',
              'sz872392',
              'sz002182',
              'sh601208',
              'sh603933',
              'sz301515',
              'sh603309',
              'sh600530',
              'sh603155',
              'sz300693',
              'sz837821',
              'sz000415',
              'sh605090',
              'sz300691',
              'sh688261',
              'sh600826',
              'sz301007',
              'sh688189',
              'sz002908']
    # stockQueue = Queue()
    # for stock in stocks:
    #     stockQueue.put(stock)
    #
    # num_threads = 10  # 根据系统性能调整线程数量
    # threads = []
    # for i in range(num_threads):
    #     t = threading.Thread(target=worker, args=(stockQueue,))
    #     t.start()
    #     threads.append(t)
    # q.stocks =
    stocks = stocks[:50]
    pool = multiprocessing.Pool(processes=32)
    while True:
        try:

            if td.is_trading():
                # with concurrent.futures.ThreadPoolExecutor(max_workers=100) as executor:
                # futures = [executor.submit(lob_spider, stock) for stock in stocks]
                results = [pool.apply_async(lob_spider, args=(stock,)) for stock in stocks]
                for result in results:
                    try:
                        result.get()
                    except Exception as e:
                        print(e)
                time.sleep(2)
            else:
                print("Non-trading hours,please waiting for  minutes")
                time.sleep(60)
        except Exception as e:
            print(e)
